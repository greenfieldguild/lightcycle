#!/usr/bin/env python3
import sys
sys.path.insert(0,"/home/temujin9/Projects/Greenfield_Guild/code/")

import boto3
import botocore.exceptions
import click
import colorama
import configparser
from lightcycle.meh import meh
import lightcycle.s3.org
import os

def header(s):
  click.secho("\n# "+s+" #", bold=True)

def fail(string,code=1):
  click.echo(string)
  exit(code)

@click.group()
@click.pass_context
def cli(ctx):
  config = configparser.ConfigParser()
  config.read(os.path.join(click.get_app_dir("lightcycle"),"org.ini"))
  ctx.obj = config
  header("Starting lightcycle "+ctx.invoked_subcommand)

@cli.command()
@click.option("--org", default=False, help="Organization short name")
@click.pass_context
def status(ctx, org):
  """Show status of this lightcycle setup"""
  if not org:
    if not "default" in ctx.obj["orgs"]:
      fail("No --org supplied and no default in config, cannot continue")
    org = ctx.obj["orgs"]["default"]
  if not org in ctx.obj["orgs"]:
    fail("Org name "+org+" is not in config, run 'lightcycle config' to configure an existing one, or 'lightcycle init' to create a new one")
  path = ctx.obj["orgs"][org]
  meh("Look for org config at "+path)
  meh("status","collect status info")
  has_init = False
  if not has_init:
    #click.echo("Not in a lightcycle installation. Run 'lightcycle init' to connect to (or create) one.")
    exit()
  endpoints = []
  if len(endpoints) == 0:
    click.echo("No endpoints found. Run 'lightcycle create' to build your first one.")
    exit()
  meh("status","display endpoint info")
  # for loop on endpoints
    # list basic status info
    # list clusters
  fail("Lots of MEH here")

@cli.command()
@click.option("--org", prompt="Org", help="Organization short name")
#@click.option("--backend", default="s3", help="Backend to use (currently only s3)")
@click.option("--path", default="", help="Path to lightcycle shared store")
@click.option("--region", default="us-east-1", help="AWS region for shared resources")
#@click.option("--force", is_flag=True, default=False, help="Force a reinitialization (DANGEROUS)")
def init(org, path, region="us-east-1"):
  """Create the shared organizational config"""
  path = path if path else org+"-lightcycle"
  org = lightcycle.s3.org.Organization(
    name = org,
    path = path,
    region = region,
  )
  header("Setting up "+org.name)
  try:
    org.create()
    org.config()
    click.echo("Created lightcycle installation at "+org.path)
  except Exception as err:
    fail(str(err))
  fail("Lots of MEH here")

@cli.command()
@click.option("--org", prompt="Org", help="Organization short name")
#@click.option("--backend", default="s3", help="Backend to use (currently only s3)")
@click.option("--path", default="", help="Path to lightcycle shared store")
@click.option("--force", is_flag=True, default=False, help="Overwrite existing local config")
def config(org,path,force):
  """Set up local configuration"""
  path = path if path else org+"-lightcycle"
  bucket, _, subpath = path.partition("/")
  org = lightcycle.s3.org.Organization(
    name = org,
    bucket = bucket,
    path = subpath,
  )
  org.load()
  org.config()
  click.echo("Set up local configuration from "+path)
  fail("Lots of MEH here")

@cli.command()
def create(**args):
  """Create a lightcycle endpoint"""
  meh("create", **args)
  fail("Lots of MEH here")

@cli.command()
def launch(**args):
  """Launch a lightcycle cluster"""
  meh("launch", **args)
  fail("Lots of MEH here")

@cli.command()
def promote(**args):
  """Promote a lightcycle cluster"""
  meh("promote", **args)
  fail("Lots of MEH here")

@cli.command()
def prune(**args):
  """Remove lightcycle cluster(s)"""
  meh("prune", **args)
  fail("Lots of MEH here")

@cli.command()
def destroy(**args):
  """Remove lightcycle endpoint or shared config"""
  meh("prune", **args)
  fail("Lots of MEH here")

if __name__ == '__main__':
  cli()
